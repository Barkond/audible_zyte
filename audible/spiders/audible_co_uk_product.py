import json
import scrapy
from urllib.parse import urljoin

RAW_PRODUCT_IDS = """B004EVK3HG
,B004FJHGE0
,B004HJBZV8
,B004S7OIOU
,B004ZGYFQA
,B0064DYOUE
,B007KBKVEW
,B007W5BSX4
,B004ELYQIS
,B004EXITL6
,B004EXLXKU
,B004EXH12O
,B004EXM12E
,B004FUCZPY
,B004FUB9QK
,B004FQ6F1I
,B004FUF6LY
,B004HGQAXO
,B004R632VM
,B00528CHDI
,B004UML27O
,B0051OZW5I
,B005D9J9GO
,B005XQ8FJO
,B006IWBQUM
,B008FR89W6
,B00BM7F2EY
,B009CE418M
,B004F3HHQS
,B004F3L2DC
,B004F47NYS
,B0057IAPNC
,B005HXOBNC
,B006PJ5KRI
,B00H3RF6XE
,B00JPML08U
,B00L5ONYT4
,B00OSNS6XS
,B00PJOY4CC
,B00UW3SULG
,B010BWBD98
,B016N9UV7S
,B018INSUSY
,B01A646I8M
,B01AIFXYAY
,B01AIY5O8U
,B01NB1BHUM
,B076HZ512S
,B079MCVLKN
,B07B7QD31C
,B07CTVT8B1
,B07DX7B5PV
,B07DXZDMKV
,0241367409
,0241381061
,1473567491
,1473555191
,1787533913
,0241368928
,1787531570
,0241987520
,1405931027
,1473573181
,1473575141
,1529126673
,1473578736
,1473583128
,0241440777
,1473575753
,0241491444
,147357515X
,0241508304
,1473590701
,1473592348
,1473593174
,B004EVRQP8
,B004EVRUAO
,B004EVNPS0
,B004EVKB8W
,B004FTKOWG
,B004IQ61GO
,B006IE6196
,B005SI4PBE
,B005SI4H8K
,B00ADBGZ32
,B00BLR65N2
,B004EXK1EE
,B004EXIH5E
,B004FUCGEY
,B004EXIZRE
,B004FUESTA
,B004FUD25Q
,B004FUGSXE
,B004FUGTJW
,B004TNEGJK
,B005D9J5CC
,B0099UH0KU
,B004F3F044
,B004F41U7E
,B004F47V3Q
,B004F42R8U
,B004F46NEY
,B00699KDNK
,B00G4JPAJ2
,B00GIQ6UO0
,B00IT59XI8
,B00MQ7IV4M
,B00MY74SZU
,B00SLUVH8A
,B01CUP8E5A
,B01DE06TZM
,B01FMNS29A
,B01G5UKTZ4
,B01K8H465E
,B01MYCPB8T
,B074JGKNXT
,B075SF7YWN
,B076FHCZ9Y
,B079P5ZVH4
,B07CHTNX2D
,B07L5Q6N8R
,1405944692
,1473564980
,0241441528
,1473580366
,0241440874
,1473577616
,1405944706
,1405945753
,1473589517
,1473589916
,1473590221
,1529141184
,B004EVKDQW
,B004ZH413G
,B0083WD91E
,B0086696LO
,B008FCWLY8
,B00CP7ED3Q
,B005SI4E4C
,B004EXH8N6
,B004HGS4V0
,B004HGOLGW
,B004O3TAUK
,B004RBZ9GS
,B004TNEC8A
,B0052U1JNK
,B005BHCPUA
,B00AQ4K4W4
,B00CXS1K5G
,B00DP20G4K
,B008R7HV9G
,B009CE3XC2
,B004ELYF4S
,B004F42EW4
,B004F42QQ8
,B004F42RVW
,B005HJ6B5W
,B00H2VRF6M
,B00GIQ6LEE
,B00H3RF602
,B00FQMCTHO
,B00JZX6F02
,B00S8HGDZI
,B010R4V9CG
,B016073GHK
,B016YL48W4
,B018IO11XO
,B01940LZNC
,B01BFLRK9Q
,B01FUQEUWW
,B01H3V2J7K
,B01K8GO8TO
,B01N4DNT5Z
,B01N9IB41L
,B071VQ6P7D
,B07CTSMJ28
,B07F2DD8BN
,B07F446G91
,B07G1BV25K
,1787533794
,1473525764
,0241394996
,1473568412
,0241987962
,0241434246
,1473581044
,0241484278
,0241987741
,0241992958
,1473595975
,0241543185
,B004EVMAJU
,B004EVPMZO
,B004EVRP54
,B004EVKB4G
,B004FDN1OA
,B004SIZ6QI
,B007BF2VJU
,B006PHT1P2
,B00DD2VBZA
,B00EINBXBK
,B004FTZ5IE
,B005OCY0J6
,B005Z4FRF4
,B004EXIDG2
,B004EXK3XS
,B004FU5OSE
,B004FUAP0G
,B004FU7KDG
,B004EXGWRO
,B004FU5WNQ
,B004EM6G4E
,B004EXIWYK
,B004EXF3P6
,B004EXM3NQ
,B004FUBC5I
,B0051AZ3TW
,B005UEXLES
,B006PHSGUS
,B00720YXJU
,B007PJM11U
,B008Y4ZS0Q
,B009S9F6I0
,B009XFUUIU
,B00A0XYRTC
,B00AWSQHES
,B00A29P1L2
,B004F3H04W
,B004F408MC
,B004F47TO2
,B005AOV94C
,B00EPOYSPU
,B00F0VHHQO
,B00FBE1342
,B00JPNRBBY
,B00KRHHJL4
,B00PCVI9LO
,B00PVK3IYO
,B00UJVMHMO
,B016ANO9KW
,B01M0G48VB
,B01N6BC1CY
,B071CYXCR4
,B075X3PZ78
,B079VQ55G8
,B07FQV1HQR
,0753553279
,1787531430
,024144697X
,1473579643
,1473580412
,0241989337
,0241990009
,152912798X
,024146773X
,1787539822
,1405949627
,1529126800
,024151505X
,1781089922
,0241536170
,B004ELX6T8
,B004MCNLTE
,B00AWU94SW
,B006LPGBG0
,B004EXEYXI
,B004EXJ0HS
,B004OFL3Q2
,B004PCEKSC
,B004S7Y3HM
,B005QR9I5U
,B00609RN5U
,B0080GKLI2
,B008VUVI3Y
,B008Y5043G
,B00BPOY79U
,B00C2817T6
,B00CI8F02U
,B00E9AQL9Q
,B004F41YX4
,B00757ZQD2
,B00H2SKB4S
,B00N318XX4
,B00OV4EJ6M
,B00V6JF9MI
,B00VGTFD2Y
,B015QBXC9S
,B018UUB37A
,B01GU79R0A
,B01GVTBUQG
,B01HTZI5N2
,B01KU5XLNM
,B01LYENDNP
,B01MU8XMK3
,B06XQ6D8K8
,B0777THY3T
,B079C2BDJP
,B07CB7LF4M
,B07DGKS4CB
,0141989459
,1473566959
,B07HJ82ZFR
,B07L3ZXTBQ
,B07LGBJ66T
,1473567564
,1473574366
,0241418925
,1405939397
,1473582091
,1529128005
,1529141176
,1405947888
,B004EVK5AG
,B004FTEXI2
,B004EVPKF6
,B00740J9RO
,B007ETZ45G
,B007PIQG6C
,B007RFPUAQ
,B008FBSH5Q
,B00CP7E6GU
,B00CP7ECGO
,B00BC1E2HI
,B004EXEG5Y
,B004FUAQX2
,B004FUCKU4
,B004FU9K66
,B004FUF5TM
,B004HGM95M
,B004PKDGAC
,B005D9J3NI
,B007VECT20
,B0099UGOXO
,B00BPXOYPS
,B004F2LHO2
,B008589YS8
,B009ON5B7G
,B00A6SMIEC
,B007ERUNK4
,B004F3YQT4
,B004F47GHC
,B004F447QU
,B004SQ0RAK
,B00H3RFKOY
,B0146VNB36
,B014HINBJM
,B01609D5Y2
,B016YSOZZW
,B01CURX7N2
,B01E4JRIZM
,B01H3VUNTG
,B01LWS64NV
,B06WW6FFBD
,B06XRKFHCS
,B071CGNKGP
,B071DNHM6N
,B076FHSL26
,B07BWQ4HBP
,B07C592DBS
,0241388538
,024144408X
,147357319X
,1473566541
,0241448905
,1473578159
,1529127653
,1473589169
,1473589738
,1473590728
,024152511X
,B004ELY17Y
,B007F0NZPK
,B009HC58DQ
,B0093Q0840
,B004EXCU70
,B004FUB4DI
,B004GMPKQC
,B006NY1DFS
,B006OAYSL2
,B007PJM1QU
,B00AN6OPHA
,B00BJN6KWE
,B007SXU890
,B0082ASHPU
,B004F3GVAQ
,B004F46GTG
,B004F42Q0O
,B0050JSKTY
,B00GYFVLOY
,B00IYWB9N8
,B00KHHK2OK
,B00M4BWC0Y
,B00NJ58SJS
,B00PUY3QLG
,B00PUY3T40
,B00T6K18YW
,B00TGCN3J8
,B00UVXESQI
,B015JOWKU4
,B016N4DKGM
,B01KU596FO
,B01N8S5BRG
,B01MTV3U5Q
,B01MU9SUC7
,B06ZYWS4SY
,B071WD7XYW
,B073HFD3FV
,B0757VLDRS
,B076PRDB66
,B07B8TNCPC
,B07B8MSJS2
,B07F6KCYCP
,B07FSP7HZT
,B07FW664DS
,B07HJFMXY5
,1787533735
,1473555159
,1473568226
,0241987857
,0241422515
,0241408431
,1473580722
,1473589894
,1529142105
,0141998202
,0241993431
,1473594782
,B004EVPT84
,B004EVO2UA
,B004EVK948
,B004O3X7GI
,B004SIN8J0
,B0056HQWZY
,B004EWWXBE
,B004EWWY90
,B005OCY5MS
,B005SI4GPO
,B004EXGGES
,B004FU7LAI
,B004EXIUSI
,B004EXKLE4
,B004FU7OZA
,B004EXNP92
,B004FUEU84
,B004FU9DRW
,B004EXNRRC
,B004FQ6F0O
,B004OTY7K2
,B005C3CXKK
,B005H0Q9O4
,B006OAIFVQ
,B007D0I4J4
,B007XERDHE
,B007XFG25M
,B008VUVJ3S
,B00994NPDW
,B009AJYUGW
,B009S9EVMC
,B00DUX2JSU
,B008YSV4YG
,B004F47UDW
,B00FQO1DZQ
,B00FLXKLVE
,B00GIQ6ZO0
,B00GP120RY
,B00N32G3LC
,B012BB3E2Q
,B0146VLRO6
,B01BMODPKE
,B01CRELRVM
,B01G2MF1GC
,B01KU5XOO8
,B01MTV1Z5N
,B01N5G9KA9
,B0725ZJQPB
,B0764L979M
,B07D2BR2NW
,B07D833MY1
,B07G1F1QYD
,B07HP8MLYW
,1473572630
,147356770X
,1787538230
,1473574358
,0241465222
,0241470439
,0241508347
,0241524776
,1529142636
,B004EVPMO0
,B004EVK3US
,B004EVS0C6
,B004EVPV00
,B004EVMMSO
,B004HGVR14
,B006IF9EQW
,B007Q3ZFF4
,B0084HJHLE
,B00CZGPY5I
,B004EM9AP6
,B004EWT7ZO
,B00A7FQZBQ
,B004EXIDNK
,B004FUH0IG
,B004EXK55Y
,B004EXITNO
,B004EXLWKQ
,B004EXKO28
,B007XFG1JE
,B0080FQKX8
,B008Z2OPO2
,B00BUV5SWS
,B00CLTTXYM
,B009P2KM2U
,B004F42QFY
,B004F46DVC
,B004F42K0U
,B005CV9CJW
,B005T4VUJC
,B00GYFWFXA
,B00HWF8NSC
,B00MWAUZMY
,B010CC4UII
,B013TRFSFM
,B071G3QTN4
,B0787JP9QG
,B07B7Q2HZ2
,B07D9LBT1T
,1405935650
,1787532968
,1787535274
,024144103X
,1405943572
,0241459931
,1405947152
,0241473632
,1473582431
,0241475724
,1529141699
,0241993296
,1473596106
,1473596254
,B004DN3RT6
,B004EVJYH6
,B004EVS1PM
,B004EVK9NO
,B004SIN12Y
,B005SI4JQA
,B006PJ5FT6
,B004EWX4I0
,B005LRXQ4O
,B00718ZW6G
,B0091ZC4BS
,B004EXEK50
,B004EXIGPK
,B004EXLUHQ
,B004FUAPA6
,B004EXKLSA
,B004FUEJ8A
,B004FUENHC
,B004PC01LM
,B00528CEW2
,B005GWCUTG
,B005HF026K
,B006VHUW9A
,B006VE4PH8
,B007T8FKNI
,B009AJYV8Y
,B009L8ZBL0
,B009T918QS
,B00AFIWTCE
,B008RWSKXC
,B004F3J1E4
,B004F3ZXRI
,B004F47HIK
,B004ZGRKFI
,B005JSTVEO
,B00FA3D8PG
,B00I9CHJPA
,B00KRFZJGS
,B00V5HF368
,B00ZDG3XOG
,B015JM9QGC
,B016ATPWIO
,B01787OPYE
,B01K5UY43S
,B06ZYLYHPV
,B071R61CP6
,B074P5VK92
,B075H2PSB9
,B076FJRPN9
,B077399F8N
,B07BYM2RNL
,147356543X
,1787532658
,0241984424
,0241982472
,1405942770
,1473532078
,1473574889
,0241423155
,0241422493
,0241438675
,1473575877
,140594126X
,1405944730
,147358762X
,1473589355
,1473594022
,1787539911
,147359667X
,B004EVRS24
,B004EVRMU2
,B004EMBRHA
,B007S08BVK
,B009PCF68U
,B004FUDE2W
,B004FUCJJQ
,B004EXLYPE
,B004HGOLTY
,B004HGVR46
,B0051B83XY
,B006FFZZJU
,B005OSVJBC
,B007Y81RZ8
,B00A29P0P4
,B004F44HD8
,B004QJ6ZN2
,B004QIY9Q8
,B005AOHA5E
,B005J6KCJ4
,B005VEO4GQ
,B00EOV16LI
,B00FXZZ58O
,B00WIYYD90
,B01D4Z6ML8
,B073R1PCCT
,B073V7L7RK
,B07575GL8V
,B076HYH144
,B07BWSJXY8
,B07CVDK1KX
,B07FHLSMYP
,B07L4X73BW
,0241393558
,0141992069
,1529126959
,1473584973
,0241504619
,0241452325
,1473593662
,024150838X
,B004EVMBSU
,B004EVNUMG
,B004EVMMUM
,B005H3LCWA
,B007K9YR08
,B005M42NTK
,B005OCY3JI
,B0074EKQN6
,B004EXGE1I
,B004EXEKBE
,B004EXNQTQ
,B004FUBDN4
,B004OTT18U
,B005D9J4VE
,B005FHHAUG
,B008CQIHMM
,B009W3BP00
,B00BPXPOLQ
,B009CSVYCO
,B004F3GQ4W
,B004F3L0P2
,B004EM3S68
,B004ZGS8M2
,B0058HTQ78
,B005SIMWIW
,B006PIMJT6
,B00F2KZOPE
,B00FR68766
,B00VY22Q0U
,B0192AQMUA
,B019FSMS6G
,B01FUQF9Y0
,B01G2W0X8S
,B01K5UY19A
,B01MDLLRQ6
,B01MZ9Q5QC
,B071XPJMPB
,B073QXXHFD
,B07B4HPJ6L
,B07BB118VT
,B07CTVQNG6
,B07D9KYJ6K
,1473567351
,1473572878
,1473532000
,1787538974
,024140827X
,0241435773
,1787539946
,1473576636
,0241445361
,0241453658
,0241459362
,1529128196
,1473582105
,0241509874
,1445847396
,1529141419
,1473594944
,0753559056
,0241530903
,B004EVMBV2
,B004EVRR7A
,B004SIU4K6
,B006PHSW3O
,B004EWYTR0
,B00DV2GXFA
,B004EXIE5M
,B004EXIWIQ
,B004EXIYWA
,B004EXM54I
,B004FU9HSM
,B004FUGU4Q
,B004FUBEGK
,B004S7Y3QI
,B008RM63EA
,B0096CGRUU
,B0097BBTMQ
,B004F44MT2
,B004EMAD1G
,B004F46FYC
,B006346TRA
,B00GB8CO5E
,B00GXCF9EG
,B00JS8IJXA
,B00KRHGP1Y
,B00LV53ADM
,B00OVB4UR8
,B015QBW65O
,B016ATROSA
,B01BNX0C3M
,B01M6TID1I
,B01N6HHU9S
,B01N21I4J1
,B0714K87B5
,B075VGLZ43
,B07C91TRDW
,B07C7BL9BJ
,B07D7G65XZ
,B07FSTT3JX
,1473570042
,1787534847
,1473575036
,1473574757
,0241456126
,1473581362
,0141993901
,1473582164
,1405946431
,0241990378
,1529127661
,0241511518
,1529134382
,1473592186
,1473596092
,B004EVK2XG
,B004IPNC7G
,B004SIYYQ6
,B006QN41LE
,B007F0OVXA
,B007Z937WW
,B004EWTF4M
,B004EWWXK0
,B0057QKCT6
,B00BM7GA72
,B00CMSEPDQ
,B00DV2GCFQ
,B00DZPQIJE
,B004EXEF0K
,B004EM9R9U
,B004FU5RWW
,B004EXH3AO
,B004FUGSZW
,B004FUF59M
,B004FU9NJK
,B004HE23IM
,B004OTQBJM
,B0051B7XUI
,B007007R0O
,B007TKI4JI
,B00ELISXDS
,B004F4655G
,B004F40J9O
,B00595JTZS
,B005HZEZNQ
,B006K2RMEE
,B00EQCEKCW
,B00O3J3Q00
,B00OSA7A2Y
,B010BW90XY
,B01ATZ8WMS
,B01JM6T4KO
,B071F68GK5
,B0714F55FL
,B07CVGRP63
,B07DJNH3R3
,0141987162
,1787532917
,1473555213
,1405940514
,B07LGBYVJP
,1473570220
,1787537579
,1473570387
,0241422612
,1473575826
,0241454123
,0241474515
,0241471818
,0241990122
,1473592372
,1473592283
,0241992699
,1529127742
,1473595800
,1473594634
,0241524938
,B004EMGZ22
,B008NCUBH4
,B004EWZ1NQ
,B004FU2QMG
,B004WFXIXU
,B0091ZC09Y
,B004EXGH0G
,B004FU7KZY
,B004FUEMOG
,B004FU96R4
,B004FUET58
,B0051AZ3HE
,B0050OER00
,B0051BJO5K
,B005QR9DFU
,B006811LR6
,B00766RCPM
,B007AK4V62
,B00C0ZFEFO
,B009SNQIDS
,B007SVVNIW
,B004F406K6
,B004F46IFS
,B006K2S5R2
,B00G4HH5EC
,B00L5JCR7O
,B00OZXRQK0
,B00P9TN21G
,B00PVK3632
,B0146XNRTW
,B0179YU7IE
,B018H0XXCG
,B01HP1TP5M
,B01IW3P56K
,B076DM9S8H
,B07BWT6W42
,1405936630
,B07L4218SD
,1473572304
,024139483X
,1473574412
,1473569575
,0241422485
,0241993148
,1473594251
,0241524881
,B004EVMKJA
,B004EVRYVY
,B004FTDYUK
,B004EVO0A2
,B004SIYY3E
,B005HYGTAY
,B008DKFILA
,B00BGBT2V0
,B00BPYRFIA
,B006YYGIWU
,B007ZHIH6A
,B008P0DO7I
,B00BM7FJ9M
,B00E4PNSWE
,B004FU7LE4
,B004EXLW1U
,B004EXLWB0
,B004EXGXB4
,B004EXM2VO
,B004JXUYMI
,B004PBU5D2
,B004T4XGCM
,B004YLK5JC
,B0052U1IFO
,B0056BEHOS
,B005D9JAJ0
,B005GWOUQ2
,B006OAYRQ8
,B00A7FR812
,B00CZDTFYC
,B00E9A5MZ0
,B004F3YL12
,B004F46LUK
,B0064E0D4O
,B00EQA5PY6
,B00NO58RZI
,B00PB0GT8G
,B00WV10VNW
,B01DYHVFZE
,B01G5WAW40
,B01G5UCYG6
,B01NCHX2PD
,B01N5G9L13
,B01MT876WK
,B06XGKNLSC
,B06XK6Q1WK
,B073R1L3FC
,B074VGJRBM
,B075Y2TSRP
,B0798WMQST
,B07BBVC8X1
,B07BFGMXP9
,B07BZ5NFHH
,0241367352
,1787534480
,1405937750
,1473572061
,1787537374
,1473580811
,1405929308
,0241474574
,1405949155
,1529134080
,1473591090
,1405950005
,1473596742
,B004EVMM52
,B004ZGYJ2K
,B00740JDHK
,B008OYPG2Q
,B00BC1CJTG
,B00BQHE7BO
,B00CA6W8EI
,B004EX0L5I
,B004FU4FTI
,B0057QKCG4
,B006QNPQWC
,B00A7GHY2O
,B00C282VV4
,B00CMSEOCS
,B004EXCTVW
,B004EXCUYI
,B004EXITH0
,B004FUD1DO
,B004FK8UQW
,B0050NO05S
,B004OTV0FW
,B0089FQ6TW
,B008VUVJY2
,B0099UH4JM
,B009RSYF02
,B00AN6OMWS
,B00E4POKQC
,B004F47QAO
,B004F40DUE
,B004F44I5A
,B0057XOX26
,B00FBHWGI6
,B00H8V0G6W
,B00MOPUULS
,B00V6JDV32
,B00YI9DUJ2
,B01J46P2GW
,B01MT90ZV6
,B077YT5DFK
,B0793ZLNNL
,B07DRM744P
,B07FPQZCDJ
,0241391407
,1473569095
,1787536459
,0241417023
,1473574595
,1473574560
,1473575028
,1787538850
,0241424356
,1473578914
,1473581680
,1473581818
,1787620840
,B08B3ZH34M
,024147406X
,0241491746
"""


class AudibleCoUkProductSpider(scrapy.Spider):
    name = 'audible_co_uk_product'
    # allowed_domains = ['audible.co.uk']
    start_urls = ['http://audible.co.uk/']

    def parse(self, response):
        product_ids = RAW_PRODUCT_IDS.split(',')
        first_5 = product_ids[:5]
        for product_id in first_5:
            split_id = product_id.strip()
            item_url = urljoin('https://www.audible.co.uk/pd/', split_id)
            yield scrapy.Request(url=item_url, callback=self.parse_product)

    def parse_product(self, response):
        audiobook_data, product_data = None, None
        for script in response.xpath('//div[@id=\'bottom-0\']/script'):
            if script.xpath("./self::*[contains(text(),'\"@type\": \"Audiobook\"')]/text()"):
                audiobook_data = json.loads(script.xpath("./text()").get())[0]
            elif script.xpath("./self::*[contains(text(),'\"@type\": \"Product\"')]/text()"):
                product_data = json.loads(script.xpath("./text()").get())[0]
        if not audiobook_data or not product_data:
            self.logger.error(f'No script data found for {response.url}')
            return

        item = {
            "url": response.url,
            'title_name': audiobook_data.get('name', ''),
            'no_reviews': audiobook_data.get('aggregateRating', {}).get('ratingCount', 0)
        }

        if audiobook_data.get('publisher'):
            item['publisher'] = audiobook_data['publisher']
        if audiobook_data.get('inLanguage'):
            item['lang'] = audiobook_data['inLanguage']
        if audiobook_data.get('datePublished'):
            item['publication_date'] = audiobook_data['datePublished']
        if audiobook_data.get('datePublished'):
            item['publication_date'] = audiobook_data['datePublished']
        if audiobook_data.get('aggregateRating', {}).get('ratingValue'):
            item['avg_review_score'] = audiobook_data['aggregateRating']['ratingValue'][:4]
        if audiobook_data.get('offers').get('highPrice'):
            item['buy_price'] = audiobook_data['offers']['highPrice']
        if product_data.get('productID'):
            item['asin'] = product_data['productID']
        if product_data.get('sku'):
            item['sku'] = product_data['sku']